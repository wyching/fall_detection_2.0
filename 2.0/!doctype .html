<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teachable Machine 影像辨識（Stand / Sit / Fall）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif; margin: 24px; }
    .wrap { max-width: 920px; margin: 0 auto; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 16px; margin: 14px 0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 820px) { .row { grid-template-columns: 1fr; } }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .small { color: #666; font-size: 12px; }
    #webcam, #imgPreview { width: 100%; max-width: 480px; border-radius: 12px; border: 1px solid #ddd; background: #fafafa; }
    .bar { height: 12px; background: #eee; border-radius: 999px; overflow: hidden; }
    .bar > div { height: 100%; width: 0%; background: #111; }
    .pred { display: grid; gap: 10px; margin-top: 12px; }
    .predItem { display: grid; grid-template-columns: 90px 1fr 70px; gap: 10px; align-items: center; }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Teachable Machine 影像分類 Demo</h1>

    <div class="card">
      <h2>1) 載入模型</h2>
      <button id="btnLoad">載入模型</button>
      <span id="status" class="small" style="margin-left:10px;">尚未載入</span>
    </div>

    <div class="row">
      <div class="card">
        <h2>2A) Webcam 即時辨識</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
          <button id="btnStartCam" disabled>開啟 Webcam</button>
          <button id="btnStopCam" disabled>停止 Webcam</button>
        </div>
        <video id="webcam" autoplay playsinline muted></video>
        <p class="small">提示：手機要用 https 或 localhost 才能開鏡頭。</p>
      </div>

      <div class="card">
        <h2>2B) 上傳圖片辨識</h2>
        <input id="file" type="file" accept="image/*" disabled />
        <div style="margin-top:10px;">
          <img id="imgPreview" alt="上傳預覽（尚未選擇）" />
        </div>
      </div>
    </div>

    <div class="card">
      <h2>3) 預測結果</h2>
      <div id="preds" class="pred"></div>
      <p class="small" id="top1"></p>
    </div>

   
  <!-- TFJS + TeachableMachine (image) -->
  <!-- 你的 metadata 顯示 tfjsVersion=1.7.4 / tmVersion=2.4.10 -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.4/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <script>
    // ====== 路徑：同資料夾 ======
    const MODEL_URL = "./model.json";
    const METADATA_URL = "./metadata.json";

    let model = null;
    let maxPredictions = 0;

    // webcam
    let stream = null;
    let rafId = null;

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const predsEl = $("preds");
    const top1El = $("top1");
    const btnLoad = $("btnLoad");
    const btnStartCam = $("btnStartCam");
    const btnStopCam = $("btnStopCam");
    const fileInput = $("file");
    const webcamVideo = $("webcam");
    const imgPreview = $("imgPreview");

    function setStatus(msg) { statusEl.textContent = msg; }

    function renderPredUI(classNames) {
      predsEl.innerHTML = "";
      classNames.forEach((name, i) => {
        const row = document.createElement("div");
        row.className = "predItem";
        row.innerHTML = `
          <div><strong>${name}</strong></div>
          <div class="bar"><div id="bar-${i}"></div></div>
          <div id="val-${i}">0%</div>
        `;
        predsEl.appendChild(row);
      });
    }

    function updatePredUI(prediction) {
      // prediction: [{className, probability}, ...]
      let best = prediction[0];
      for (const p of prediction) if (p.probability > best.probability) best = p;

      prediction.forEach((p, i) => {
        const pct = Math.round(p.probability * 1000) / 10; // 1 decimal
        const bar = document.getElementById(`bar-${i}`);
        const val = document.getElementById(`val-${i}`);
        if (bar) bar.style.width = `${pct}%`;
        if (val) val.textContent = `${pct}%`;
      });

      top1El.textContent = `Top-1：${best.className}（${(best.probability*100).toFixed(1)}%）`;
    }

    async function loadModel() {
      setStatus("載入中…");
      btnLoad.disabled = true;

      try {
        model = await tmImage.load(MODEL_URL, METADATA_URL);
        maxPredictions = model.getTotalClasses();

        // 建 UI：讀出 classNames
        const classNames = model.getClassLabels ? model.getClassLabels() : null;
        // 兼容：有些版本用 metadata 的 labels，這裡用 predict 一次也能拿到 className
        const names = classNames && classNames.length ? classNames : ["Class0", "Class1", "Class2"];
        renderPredUI(names);

        setStatus(`模型已載入（classes: ${maxPredictions}）`);
        btnStartCam.disabled = false;
        fileInput.disabled = false;
      } catch (err) {
        console.error(err);
        setStatus("載入失敗：請確認 model.json / metadata.json 路徑與是否用本機伺服器");
        btnLoad.disabled = false;
      }
    }

    async function startWebcam() {
      if (!model) return;

      btnStartCam.disabled = true;
      btnStopCam.disabled = false;

      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
        webcamVideo.srcObject = stream;

        const loop = async () => {
          if (!stream) return;
          await predictFromVideo();
          rafId = requestAnimationFrame(loop);
        };
        loop();
      } catch (err) {
        console.error(err);
        setStatus("Webcam 開啟失敗：請允許相機權限，或改用圖片上傳");
        btnStartCam.disabled = false;
        btnStopCam.disabled = true;
      }
    }

    function stopWebcam() {
      btnStopCam.disabled = true;
      btnStartCam.disabled = false;

      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;

      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      webcamVideo.srcObject = null;
    }

    async function predictFromVideo() {
      if (!model) return;
      // 直接拿 video element 做推論
      const prediction = await model.predict(webcamVideo);
      updatePredUI(prediction);
    }

    async function predictFromImage(imgEl) {
      if (!model) return;
      const prediction = await model.predict(imgEl);
      updatePredUI(prediction);
    }

    // events
    btnLoad.addEventListener("click", loadModel);
    btnStartCam.addEventListener("click", startWebcam);
    btnStopCam.addEventListener("click", stopWebcam);

    fileInput.addEventListener("change", async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;

      const url = URL.createObjectURL(f);
      imgPreview.src = url;
      imgPreview.onload = async () => {
        URL.revokeObjectURL(url);
        await predictFromImage(imgPreview);
      };
    });
  </script>
</body>
</html>
